<div class="community-detail-container">
  <!-- Header with refresh button -->
  <div class="community-header-action" *ngIf="!loading && !error && community">
    <button mat-icon-button class="refresh-button" (click)="loadCommunityDetails()" [disabled]="loading" matTooltip="Refresh community data">
      <fa-icon [icon]="faArrowsRotate" [spin]="loading"></fa-icon>
    </button>
  </div>

  <div *ngIf="loading" class="loading-spinner">
    <div class="spinner-container">
      <fa-icon [icon]="faSpinner" [spin]="true" size="1x"></fa-icon>
    </div>
    <p>Loading community details...</p>
  </div>
  <div *ngIf="error" class="error-container">
    <div class="error-card">
      <div class="error-card-content">
        <fa-icon [icon]="faCircleExclamation" class="error-icon"></fa-icon>
        <h3>Error loading community</h3>
        <p>{{ error }}</p>
        <app-custom-button variant="primary" size="medium" [icon]="faArrowRight" (buttonClick)="loadCommunityDetails()">
          Try Again
        </app-custom-button>
      </div>
    </div>
  </div>
  
  <ng-container *ngIf="community && !loading && !error">
    <div class="community-header">
      <div class="custom-card">
        <div class="community-header-content">
          <div class="community-info">
            <h1>{{ community.name }}</h1>
            <p class="description">{{ community.description }}</p>
            
            <div class="community-stats">
              <div class="stat-item">
                <fa-icon [icon]="faUsers" class="stat-icon"></fa-icon>
                <div class="stat-content">
                  <span class="stat-label">Members</span>
                  <span class="stat-value">{{ getActiveMembersCount() }}/{{ communitySettings?.maxMembers || 'Unlimited' }}</span>
                </div>
              </div>
              <div class="stat-item">
                <fa-icon [icon]="faCalendarDays" class="stat-icon"></fa-icon>
                <div class="stat-content">
                  <span class="stat-label">Current Cycle</span>
                  <span class="stat-value">{{ community.cycles.length || 'Not started' }}</span>
                </div>
              </div>
              <div class="stat-item">
                <fa-icon [icon]="faDollarSign" class="stat-icon"></fa-icon>
                <div class="stat-content">
                  <span class="stat-label">Contribution</span>
                  <span class="stat-value">${{ communitySettings?.minContribution || 0 }} {{ getContributionFrequencyText(community.settings.contributionFrequency) }}</span>
                </div>
              </div>
              <div class="stat-item">
                <fa-icon [icon]="faPiggyBank" class="stat-icon"></fa-icon>
                <div class="stat-content">
                  <span class="stat-label">Backup Fund</span>
                  <span class="stat-value">${{ community.backupFund || 0 }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="community-actions">
            <ng-container *ngIf="currentUserId">              <app-custom-button *ngIf="!isMember" variant="primary" size="medium" 
                [icon]="faRightToBracket" [disabled]="loading"
                (buttonClick)="joinCommunity()">
                Join Community
              </app-custom-button>
              
              <!-- <app-custom-button *ngIf="isAdmin" variant="secondary" size="medium" 
                [icon]="faPlay" [disabled]="loading" class="ml-2"
                (buttonClick)="startNewCycle()">
                Start New Cycle
              </app-custom-button> -->
            </ng-container>
            <app-custom-button *ngIf="!currentUserId" variant="primary" size="medium" 
              [icon]="faRightToBracket" url="/login" 
              [queryParams]="{returnUrl: '/communities/' + communityId}">
              Log in to Join
            </app-custom-button>
          </div>
        </div>
      </div>
    </div>
      <div class="custom-tabs-container">      <div class="custom-tabs-header">
        <div class="tab-button" [class.active]="activeTab === 'overview'" (click)="setActiveTab('overview')">
          <fa-icon [icon]="faCircleInfo"></fa-icon>
          <span>Overview</span>
        </div>
        <!-- Only members can see these tabs -->
        <ng-container *ngIf="isMember">
          <div class="tab-button" [class.active]="activeTab === 'members'" (click)="setActiveTab('members')">
            <fa-icon [icon]="faUsers"></fa-icon>
            <span>Members</span>
          </div>        
          <div class="tab-button" [class.active]="activeTab === 'midcycle'" (click)="setActiveTab('midcycle')">
            <fa-icon [icon]="faChartPie"></fa-icon>
            <span>Mid-Cycle</span>
          </div>
          <div class="tab-button" [class.active]="activeTab === 'contributionHistory'" (click)="setActiveTab('contributionHistory')">
            <fa-icon [icon]="faHistory"></fa-icon>
            <span>Contribution History</span>
          </div>
          <div class="tab-button" [class.active]="activeTab === 'votes'" (click)="setActiveTab('votes')">
            <fa-icon [icon]="faBallotCheck"></fa-icon>
            <span>Votes</span>
          </div>
          <div class="tab-button" [class.active]="activeTab === 'payouts'" (click)="setActiveTab('payouts')">
            <fa-icon [icon]="faDollarSign"></fa-icon>
            <span>Payouts</span>
          </div>
        </ng-container>
      </div>
      
      <div class="custom-tabs-content">
        <!-- Overview Tab -->
        <div class="tab-panel" *ngIf="activeTab === 'overview'">
          <div class="tab-content">
            <div class="section">
              <h2>Community Overview</h2>
              <div class="custom-card">
                <div class="card-content">
                  <div class="overview-grid">
                    <div class="overview-item">
                      <div class="item-label">Admin</div>
                      <div class="item-value admin-info">
                        <fa-icon [icon]="faUser" class="admin-icon"></fa-icon>
                        <span>{{ community.admin || 'Not assigned' }}</span>
                      </div>
                    </div>
                    <div class="overview-item">
                      <div class="item-label">Created On</div>
                      <div class="item-value">{{ formatDate(community.createdAt) }}</div>
                    </div>
                    <div class="overview-item">
                      <div class="item-label">Status</div>
                      <div class="item-value">
                        <div class="status-chip" [ngClass]="community.active ? 'active-chip' : 'inactive-chip'">
                          {{ community.cycleState ? 'Active' : 'Locked' }}
                        </div>
                      </div>
                    </div>
                    <div class="overview-item">
                      <div class="item-label">Total Contribution</div>
                      <div class="item-value">${{ community.totalContribution || 0 }}</div>
                    </div>
                    <div class="overview-item">
                      <div class="item-label">Contribution Frequency</div>
                      <div class="item-value">{{ getContributionFrequencyText(community.settings.contributionFrequency) }}</div>
                    </div>
                    <div class="overview-item">
                      <div class="item-label">Minimum Contribution</div>
                      <div class="item-value">${{ community.settings.minContribution || 0 }}</div>
                    </div>
                    <div class="overview-item">
                      <div class="item-label">Maximum Members</div>
                      <div class="item-value">{{ community.settings.maxMembers || 'Unlimited' }}</div>
                    </div>
                    <div class="overview-item">
                      <div class="item-label">Backup Fund Percentage</div>
                      <div class="item-value">{{ community.settings.backupFundPercentage || 0 }}%</div>
                    </div>
                    <div class="overview-item">
                      <div class="item-label">Positioning Mode</div>
                      <div class="item-value">{{ community.positioningMode || 'Not set' }}</div>
                    </div>
                    <div class="overview-item">
                      <div class="item-label">Lock Payout</div>
                      <div class="item-value">{{ community.lockPayout ? 'Yes' : 'No' }}</div>
                    </div>
                    <div class="overview-item">
                      <div class="item-label">Cycle Lock</div>
                      <div class="item-value">{{ community.cycleLockEnabled ? 'Locked' : 'Open' }}</div>
                    </div>
                    <div class="overview-item">
                      <div class="item-label">Penalty Fee</div>
                      <div class="item-value">{{ communitySettings?.penalty || 0 }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
              <!-- Next Payout section removed as it's duplicated in Current Cycle Information -->
            <div class="section" *ngIf="getCurrentCycle()">
              <h2>Current Cycle Information</h2>
              <div class="custom-card">
                <div class="card-content">
                  <div class="cycle-info">
                    <div class="cycle-header">
                      <span class="cycle-number">Cycle {{ getCurrentCycle()?.cycleNumber }}</span>
                      <div class="status-chip" [ngClass]="getCurrentCycle()?.isComplete ? 'complete-chip' : 'in-progress-chip'">
                        {{ getCurrentCycle()?.isComplete ? 'Complete' : 'In Progress' }}
                      </div>
                    </div>
                    
                    <div class="cycle-dates">
                      <div class="cycle-date">
                        <fa-icon [icon]="faCalendarDays" class="date-icon"></fa-icon>
                        <div>
                          <span class="date-label">Start Date</span>
                          <span class="date-value">{{ formatDate(getCurrentCycle()?.startDate || undefined) }}</span>
                        </div>
                      </div>
                      <div class="cycle-date" *ngIf="getCurrentCycle()?.isComplete">
                        <fa-icon [icon]="faCalendarDays" class="date-icon"></fa-icon>
                        <div>
                          <span class="date-label">End Date</span>
                          <span class="date-value">{{ formatDate(getCurrentCycle()?.endDate || undefined) }}</span>
                        </div>
                      </div>
                    </div>
                      <!-- Current Mid-Cycle Section -->
                    <div class="current-midcycle-section" *ngIf="midCycleDetails">
                      <h3 class="midcycle-section-title">Current Mid-Cycle</h3>                      <div class="midcycle-card" [ngClass]="{'midcycle-complete': midCycleDetails.isComplete, 'midcycle-ready': midCycleDetails.isReady && !midCycleDetails.isComplete, 'midcycle-in-progress': !midCycleDetails.isReady && !midCycleDetails.isComplete}">
                        <div class="midcycle-header">
                          <h5>Mid-Cycle {{ midCycleDetails.midCycleId }}</h5>
                          <div class="status-chip" [ngClass]="{'complete-chip': midCycleDetails.isComplete, 'ready-chip': midCycleDetails.isReady && !midCycleDetails.isComplete, 'in-progress-chip': !midCycleDetails.isReady && !midCycleDetails.isComplete}">
                            {{ midCycleDetails.isComplete ? 'Complete' : midCycleDetails.isReady ? 'Ready for Payout' : 'In Progress' }}
                          </div>
                        </div>
                          <div class="midcycle-progress vertical-progress">
                          <div class="progress-content">
                            <div class="progress-percentage">{{ getContributionProgressPercentage() }}%</div>
                            <div class="progress-bar-container">
                              <div class="progress-bar vertical" [style.height.%]="getContributionProgressPercentage()"></div>
                            </div>
                            <div class="progress-text">Complete</div>
                          </div>
                        </div>
                        
                        <div class="midcycle-details">                          <div *ngIf="midCycleDetails?.nextInLine" class="midcycle-item">
                            <span class="item-label">Next In Line:</span>
                            <span class="item-value">{{ midCycleDetails.nextInLine?.name }}</span>
                          </div>
                          <div class="midcycle-item">
                            <span class="item-label">Payout Amount:</span>
                            <span class="item-value">${{ midCycleDetails.payoutAmount || 0 }}</span>
                          </div>
                          <div *ngIf="midCycleDetails.payoutDate" class="midcycle-item">
                            <span class="item-label">Payout Date:</span>
                            <span class="item-value">{{ formatDate(midCycleDetails.payoutDate) }}</span>
                          </div>
                          <div class="midcycle-item">
                            <span class="item-label">Contributions:</span>
                            <span class="item-value">{{ midCycleDetails.contributionProgress?.made || 0 }}/{{ midCycleDetails.contributionProgress?.expected || 0 }}</span>
                          </div>
                        </div>
                          <div class="midcycle-actions" *ngIf="isMember && midCycleDetails.isReady && !isUserContributedToCurrentMidcycle()">
                          <app-custom-button variant="primary" size="small" 
                            [icon]="faMoneyBillTransfer" [disabled]="loading"
                            (buttonClick)="contributeToMidcycle(getCurrentMidcycle())">
                            Contribute
                          </app-custom-button>
                        </div>
                        
                        <!-- Admin distribute action -->
                        <div class="midcycle-actions admin-action" *ngIf="isAdmin && midCycleDetails.isReady && !midCycleDetails.isComplete">
                          <div class="action-notice">
                            <fa-icon [icon]="faCircleInfo" class="info-icon"></fa-icon>
                            <span>Ready to distribute payouts</span>
                          </div>
                          <app-custom-button variant="primary" size="small" 
                            [icon]="faDollarSign" [disabled]="loading"
                            (buttonClick)="distributePayouts()">
                            Distribute Payouts
                          </app-custom-button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
              <!-- Mid-Cycle Summary Section -->
            <div class="section" *ngIf="community">
              <h2>Mid-Cycle Summary</h2>
              <div class="custom-card">                <div class="card-content" *ngIf="loadingMidCycleDetails">
                  <div class="loading-indicator">
                    <fa-icon [icon]="faCircleInfo"></fa-icon>
                    <span>Loading mid-cycle details...</span>
                  </div>
                </div>
                <div class="card-content" *ngIf="!loadingMidCycleDetails && midCycleDetails">
                  <div class="midcycle-summary-grid">
                    <div class="midcycle-stat">
                      <div class="stat-label">Total Mid-Cycles</div>
                      <div class="stat-value">{{ getMidCycleSummary().total }}</div>
                    </div>
                    <div class="midcycle-stat">
                      <div class="stat-label">Completed</div>
                      <div class="stat-value">{{ getMidCycleSummary().completed }}</div>
                    </div>                    <div class="midcycle-stat">
                      <div class="stat-label">Active</div>
                      <div class="stat-value">{{ midCycleDetails && !midCycleDetails.isComplete ? 1 : 0 }}</div>
                    </div>
                    <div class="midcycle-stat">
                      <div class="stat-label">Total Distributed</div>
                      <div class="stat-value">${{ getMidCycleSummary().distributed }}</div>
                    </div>                  </div>                    <div class="midcycle-progress vertical-progress">
                      <h4 class="progress-title">Contribution Progress</h4>
                      <div class="progress-content">
                        <div class="progress-percentage">{{ getContributionProgressPercentage() }}%</div>
                        <div class="progress-bar-container">
                          <div class="progress-bar vertical" [style.height.%]="getContributionProgressPercentage()"></div>
                        </div>
                        <div class="progress-info-item">
                          <fa-icon [icon]="faUsers"></fa-icon>
                          <span>{{ midCycleDetails.contributionProgress?.made || 0 }}/{{ midCycleDetails.contributionProgress?.expected || 0 }} Contributions</span>
                        </div>
                        <div class="progress-info-item status" [ngClass]="{'status-complete': getContributionProgressPercentage() === 100, 'status-progress': getContributionProgressPercentage() < 100}">
                          <fa-icon [icon]="getContributionProgressPercentage() === 100 ? faCheckCircle : faCircleInfo"></fa-icon>
                          <span>{{ getContributionProgressPercentage() === 100 ? 'Complete' : 'In Progress' }}</span>
                        </div>
                      </div>
                    </div>
                </div>
              </div>
            </div>
          </div>
        </div>
          <!-- Members Tab - Only visible to members -->
        <div class="tab-panel" *ngIf="activeTab === 'members' && isMember">
          <div class="tab-content">
            <h2>Community Members</h2>
            <div class="custom-card">
              <div class="card-content">
                <div *ngIf="!community.members || community.members.length === 0" class="empty-state">
                  <fa-icon [icon]="faUsers" class="empty-icon"></fa-icon>
                  <p>No members have joined this community yet.</p>
                </div>
                
                <div class="members-list" *ngIf="community.members && community.members.length > 0">                  <div class="member-item" *ngFor="let member of community.members; let last = last" 
                       (click)="navigateToMemberDetail(member.userId)">
                    <div class="member-avatar">
                      <fa-icon [icon]="faUser"></fa-icon>
                    </div>
                    <div class="member-info">
                      <div class="member-name">{{ member.name }}</div>
                      <div class="member-joined">Joined: {{ formatDate(member.joinedAt || undefined) }}</div>
                      <div class="member-position" *ngIf="member.position !== undefined && member.position !== null">
                        Position: {{ member.position }}
                      </div>
                    </div>
                    <div class="member-status">
                      <span class="status-indicator" [ngClass]="getMemberStatusClass(member.status)">
                        <fa-icon [icon]="getMemberStatusIcon(member.status)"></fa-icon>
                        {{ member.status }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
                  <!-- Leave Community Button at the bottom of the page -->
    <div class="leave-community-container" *ngIf="isMember">
      <app-custom-button variant="destructive" size="medium" 
        [icon]="faRightFromBracket" [disabled]="loading"
        (buttonClick)="leaveCommunity()">
        Leave Community
      </app-custom-button>
    </div>
          </div>
        </div>
        
        <!-- Mid-cycle Tab -->
        <div class="tab-panel" *ngIf="activeTab === 'midcycle' && isMember">
          <div class="tab-content">
            <div class="section">
              <h2>Current Mid-Cycle</h2>
                <div class="custom-card" *ngIf="loadingMidCycleDetails">
                <div class="card-content">
                  <div class="loading-indicator">
                    <fa-icon [icon]="faCircleInfo"></fa-icon>
                    <span>Loading mid-cycle details...</span>
                  </div>
                </div>
              </div>
              
              <div class="custom-card" *ngIf="!loadingMidCycleDetails && !midCycleDetails">
                <div class="card-content">
                  <p>No active mid-cycle found for this community.</p>
                </div>
              </div>
              
              <div *ngIf="!loadingMidCycleDetails && midCycleDetails">
                <!-- Current Cycle Information -->
                <div class="custom-card mb-4">
                  <div class="card-header">
                    <h3>Current Cycle Information</h3>
                  </div>
                  <div class="card-content">
                    <div class="cycle-info-grid">
                      <div class="info-item">
                        <div class="info-label">Cycle Number</div>
                        <div class="info-value">{{ midCycleDetails.currentCycle?.cycleNumber || 0 }}</div>
                      </div>
                      <div class="info-item">
                        <div class="info-label">Start Date</div>
                        <div class="info-value">{{ midCycleDetails.currentCycle?.startDate | date:'mediumDate' }}</div>
                      </div>
                      <div class="info-item">
                        <div class="info-label">Expected End Date</div>
                        <div class="info-value">{{ midCycleDetails.currentCycle?.expectedEndDate | date:'mediumDate' }}</div>
                      </div>
                      <div class="info-item">
                        <div class="info-label">Paid Members</div>
                        <div class="info-value">{{ midCycleDetails.currentCycle?.paidMembers || 0 }}/{{ midCycleDetails.currentCycle?.totalMembers || 0 }}</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Mid-cycle Status -->                <div class="custom-card mb-4">
                  <div class="card-header">
                    <h3>Mid-Cycle Status</h3>
                    <div class="status-badge" [ngClass]="{'ready': midCycleDetails.isReady, 'in-progress': !midCycleDetails.isReady && !midCycleDetails.isComplete, 'completed': midCycleDetails.isComplete}">
                      {{ midCycleDetails.isComplete ? 'Completed' : (midCycleDetails.isReady ? 'Ready for Payout' : 'In Progress') }}
                    </div>
                  </div>                  <div class="card-content">                    <div class="midcycle-progress vertical-progress">
                      <h4 class="progress-title">Contribution Progress</h4>
                      <div class="progress-content">
                        <div class="progress-percentage">{{ getContributionProgressPercentage() }}%</div>
                        <div class="progress-bar-container">
                          <div class="progress-bar vertical" [style.height.%]="getContributionProgressPercentage()"></div>
                        </div>
                        <div class="progress-info-item">
                          <fa-icon [icon]="faUsers"></fa-icon>
                          <span>{{ midCycleDetails.contributionProgress?.made || 0 }}/{{ midCycleDetails.contributionProgress?.expected || 0 }} Contributions</span>
                        </div>
                        <div class="progress-info-item status" [ngClass]="{'status-complete': getContributionProgressPercentage() === 100, 'status-progress': getContributionProgressPercentage() < 100}">
                          <fa-icon [icon]="getContributionProgressPercentage() === 100 ? faCheckCircle : faCircleInfo"></fa-icon>
                          <span>{{ getContributionProgressPercentage() === 100 ? 'Complete' : 'In Progress' }}</span>
                        </div>
                      </div>
                    </div>                    
                    <div class="next-payout-info" *ngIf="midCycleDetails.nextInLine">
                      <h4>Next Payout Information</h4>
                      <div class="payout-grid">
                        <div class="payout-item">
                          <div class="payout-label">Recipient</div>
                          <div class="payout-value">{{ midCycleDetails.nextInLine.name }}</div>
                        </div>
                        <div class="payout-item">
                          <div class="payout-label">Amount</div>
                          <div class="payout-value">${{ midCycleDetails.payoutAmount }}</div>
                        </div>
                        <div class="payout-item">
                          <div class="payout-label">Scheduled Date</div>
                          <div class="payout-value">{{ midCycleDetails.payoutDate | date:'mediumDate' }}</div>
                        </div>                      </div>
                    </div>
                    
                    <!-- Admin Payout Action -->
                    <div class="admin-actions" *ngIf="isAdmin && midCycleDetails.isReady && !midCycleDetails.isComplete">
                      <div class="action-notice">
                        <fa-icon [icon]="faCircleInfo" class="info-icon"></fa-icon>
                        <span>As the administrator, you can now distribute payouts for this mid-cycle</span>
                      </div>
                      <app-custom-button variant="primary" size="medium" 
                        [icon]="faDollarSign" [disabled]="loading"
                        (buttonClick)="distributePayouts()">
                        Distribute Payouts
                      </app-custom-button>
                    </div>
                  </div>
                </div>
                
                <!-- Mid-cycle Contributors -->
                <div class="custom-card">
                  <div class="card-header">
                    <h3>Contributors</h3>
                  </div>                  <div class="card-content">
                    <div class="contributors-list" *ngIf="midCycleDetails?.contributions && midCycleDetails.contributions.length > 0">
                      <div class="contributor-item" *ngFor="let contributor of midCycleDetails.contributions">
                        <div class="contributor-info">
                          <span class="contributor-name">{{ contributor.user ? contributor.user.name : 'Unknown User' }}</span>
                          <span class="contributor-email">{{ contributor.user ? contributor.user.email : '' }}</span>
                        </div>
                        <div class="contribution-amount">
                          <span class="amount-label">Amount:</span>
                          <span class="amount-value">${{ contributor.totalAmount || 0 }}</span>
                        </div>
                        <div class="contribution-status">
                          <fa-icon [icon]="faCheckCircle" class="status-icon contributed"></fa-icon>
                          <span>Contributed</span>
                        </div>
                      </div>
                    </div>
                    <div class="empty-state" *ngIf="!midCycleDetails?.contributions || midCycleDetails.contributions.length === 0">
                      <fa-icon [icon]="faMoneyBillTransfer" class="empty-icon"></fa-icon>
                      <p>No contributions have been made in this mid-cycle yet.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
          <!-- Removed Contributions Tab --><!-- Contribution History Tab (Hierarchical) -->
        <div class="tab-panel" *ngIf="activeTab === 'contributionHistory' && isMember">
          <div class="tab-content">
            <div class="section-header-with-action">
              <h2>Community Contribution History</h2>
              <app-custom-button *ngIf="isMember && !loading" variant="primary" size="medium" 
                [icon]="faMoneyBillTransfer" 
                (buttonClick)="navigateToContributionPage()">
                Make Contribution
              </app-custom-button>
            </div>
            <app-contribution-history-hierarchical [communityId]="communityId"></app-contribution-history-hierarchical>
            <!-- Debug output -->
            <div class="debug-section" *ngIf="false">
              <pre>{{ contributionHistoryDebug | json }}</pre>
            </div>
          </div>
        </div>
        
        <!-- Votes Tab -->
        <div class="tab-panel" *ngIf="activeTab === 'votes' && isMember">
          <div class="tab-content">
            <div class="section-header-with-action">
              <h2>Community Votes</h2>
              <div class="action" *ngIf="isAdmin">
                <app-custom-button variant="primary" size="small" (buttonClick)="createNewVote()">
                  Create New Vote
                </app-custom-button>
              </div>
            </div>            <!-- Create Vote Form (Admins Only) -->
            <div class="custom-card vote-create-section" *ngIf="isAdmin">
              <h3>Create a New Vote</h3>
              <div class="vote-form">
                <div class="form-group">
                  <label for="voteTopic">Vote Topic</label>
                  <select id="voteTopic" [(ngModel)]="newVote.topic" class="form-control" (change)="onVoteTopicChange()">
                    <option value="">Select a topic to vote on</option>
                    <option *ngFor="let topic of voteTopics" [value]="topic.value">
                      {{ topic.label }}
                    </option>
                  </select>
                    <!-- Topic description for guidance -->
                  <div class="topic-description" *ngIf="newVote.topic">
                    <p>
                      {{ getVoteTopicDescription(newVote.topic) }}
                    </p>
                  </div>
                </div>
                  <!-- Predefined options display -->
                <div class="options-container" *ngIf="newVote.topic && isPredefinedTopic(newVote.topic)">
                  <label>Available Options</label>
                  <div class="predefined-options">
                    <div class="option-badge" *ngFor="let option of getOptionsForSelectedTopic()">
                      {{ option }}
                    </div>
                    <p class="option-helper-text">These options are predefined based on your selected topic.</p>
                  </div>
                </div>
                
                <!-- Custom options (shown only for non-predefined topics) -->
                <div class="options-container" *ngIf="newVote.topic && !isPredefinedTopic(newVote.topic)">
                  <label>Options</label>
                  <div class="option-row" *ngFor="let option of newVote.options; let i = index">
                    <input type="text" [(ngModel)]="newVote.options[i]" 
                           placeholder="Option {{i+1}}" class="form-control">                    <button type="button" class="option-button remove" 
                            (click)="removeVoteOption(i)" *ngIf="newVote.options.length > 2">
                      <fa-icon [icon]="faMinus"></fa-icon>
                    </button>
                  </div>
                  <button type="button" class="option-button add" (click)="addVoteOption()">
                    <fa-icon [icon]="faPlus"></fa-icon> Add Option
                  </button>
                </div>
                
                <div class="form-actions">
                  <app-custom-button variant="secondary" size="small" 
                    [disabled]="!newVote.topic"
                    (buttonClick)="createNewVote()">
                    Create Vote
                  </app-custom-button>
                </div>
              </div>
            </div>

            <!-- Votes List -->
            <div class="votes-list" *ngIf="votes.length > 0">              <div class="vote-item custom-card" *ngFor="let vote of votes">
                <div class="vote-header">
                  <h3>{{ getTopicDisplayLabel(vote.topic) }}</h3>
                  <span class="vote-status" [class.resolved]="vote.resolved">
                    {{ vote.resolved ? 'Resolved' : 'Active' }}
                  </span>
                </div>
                
                <div class="vote-options">
                  <div class="option-item" *ngFor="let option of vote.options">
                    <div class="option-details">
                      <div class="option-text">{{ option }}</div>
                      <div class="option-count">{{ getVoteCount(vote, option) }} votes</div>
                    </div>
                    
                    <div class="progress-container">
                      <div class="progress-bar" [style.width.%]="getVotePercentage(vote, option)"></div>
                      <div class="progress-text">{{ getVotePercentage(vote, option) }}%</div>
                    </div>
                    
                    <button *ngIf="!vote.resolved && isMember && !hasUserVoted(vote)" 
                            class="vote-button" (click)="castVote(vote._id, option)">
                      Vote
                    </button>
                    <span *ngIf="getUserVoteChoice(vote) === option" class="user-voted">
                      <fa-icon [icon]="faCheckCircle"></fa-icon> Your vote
                    </span>
                  </div>
                </div>
                
                <div class="vote-footer">
                  <div class="vote-stats">
                    <span>Total Votes: {{ vote.numVotes }}</span>
                    <span>Created: {{ formatDate(vote.createdAt) }}</span>
                  </div>
                  <div class="vote-actions" *ngIf="vote.resolved">
                    <span class="resolution">Resolution: {{ vote.resolution }}</span>
                    <span class="applied-status" [class.applied]="vote.applied">
                      {{ vote.applied ? 'Applied' : 'Pending Application' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Empty State -->
            <div class="empty-state" *ngIf="!loadingVotes && votes.length === 0">
              <fa-icon [icon]="faBallotCheck" class="empty-icon"></fa-icon>
              <h3>No Votes Yet</h3>
              <p>There are no votes in this community yet.</p>
              <span *ngIf="isAdmin">You can create a new vote to get community feedback on important decisions.</span>
            </div>
            
            <!-- Loading State -->
            <div class="loading-indicator" *ngIf="loadingVotes">
              <fa-icon [icon]="faSpinner" [spin]="true"></fa-icon>
              <span>Loading votes...</span>
            </div>
          </div>
        </div>
        
        <!-- Payouts Tab -->
        <div class="tab-panel" *ngIf="activeTab === 'payouts' && isMember">
          <div class="tab-content">
            <h2>Payout Schedule</h2>
            <div class="custom-card">
              <div class="card-content">
                <div *ngIf="!community.cycles || community.cycles.length === 0 || !community.payoutDetails" class="empty-state">
                  <fa-icon [icon]="faMoneyBillTransfer" class="empty-icon"></fa-icon>
                  <p>No payout information is available yet. Payouts will be scheduled once the community cycle begins.</p>
                </div>
                
                <div *ngIf="community.payoutDetails && community.cycles && community.cycles.length > 0" class="payout-info">
                  <div class="next-payout-large">
                    <h3>Next Payout</h3>
                    <div class="payout-details">
                      <div class="payout-stat">
                        <fa-icon [icon]="faUser" class="payout-icon"></fa-icon>
                        <div class="payout-content">
                          <span class="payout-label">Recipient: </span>
                          <span class="payout-value">{{ community.payoutDetails.nextRecipient || 'Not assigned yet' }}</span>
                        </div>
                      </div>
                      
                      <div class="payout-stat">
                        <fa-icon [icon]="faMoneyBillTransfer" class="payout-icon"></fa-icon>
                        <div class="payout-content">
                          <span class="payout-label">Amount</span>
                          <span class="payout-value">${{ community.payoutDetails.payoutAmount || 0 }}</span>
                        </div>
                      </div>
                      
                      <div class="payout-stat">
                        <fa-icon [icon]="faCalendarDays" class="payout-icon"></fa-icon>
                        <div class="payout-content">
                          <span class="payout-label">Date: </span>
                          <span class="payout-value">{{ formatDate(payDate) }}</span>
                          <!-- <span>{{payDate}}</span> -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>      </div>
    </div>

  </ng-container>
  
  <!-- Information box for non-members -->
  <div class="section" *ngIf="!isMember && currentUserId">
    <div class="custom-card info-card">
      <div class="card-content">
        <div class="info-message">
          <fa-icon [icon]="faCircleInfo" class="info-icon"></fa-icon>
          <div class="info-text">
            <h4>Join this community for full access</h4>
            <p>Members can view detailed information, contribution history, votes, and participate in community activities.</p>
            <app-custom-button variant="primary" size="small" 
              [icon]="faRightToBracket" [disabled]="loading"
              (buttonClick)="joinCommunity()">
              Join Community
            </app-custom-button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Information box for non-logged in users -->
  <div class="section" *ngIf="!currentUserId">
    <div class="custom-card info-card">
      <div class="card-content">
        <div class="info-message">
          <fa-icon [icon]="faCircleInfo" class="info-icon"></fa-icon>
          <div class="info-text">
            <h4>Sign in for full access</h4>
            <p>Log in to join this community and access detailed information, contribution history, votes and more.</p>
            <app-custom-button variant="primary" size="small" 
              [icon]="faRightToBracket" url="/login" 
              [queryParams]="{returnUrl: '/communities/' + communityId}">
              Log in to Join
            </app-custom-button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>